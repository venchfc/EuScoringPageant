{% extends "base.html" %}

{% block title %}Scores - Judge Breakdown{% endblock %}

{% block extra_css %}
<style>
    .score-section-title {
        color: #880015;
        font-weight: 700;
    }

    .score-card {
        border: 1px solid #e6e6e6;
        border-radius: 10px;
        padding: 12px 14px;
        background: #ffffff;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
const socket = window.AppSocket;
if (socket) {
    socket.on('scores_update', () => window.location.reload());
}
</script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2>Scores</h2>
        <p class="text-muted mb-0">Judge score breakdown by contestant, category, and criteria.</p>
    </div>
</div>

{% if not judge_entries %}
    <div class="alert alert-info">No judges found.</div>
{% else %}
    {% for entry in judge_entries %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                Judge #{{ entry.judge.number }} - {{ entry.judge.name }}
            </div>
            <div class="card-body">
                {% if not entry.contestants %}
                    <div class="alert alert-info mb-0">No scores recorded for this judge yet.</div>
                {% else %}
                    {% for category in categories %}
                        {% set category_criteria = criteria_by_category.get(category.id, []) %}
                        {% set has_scores = namespace(value=false) %}
                        {% for contestant_entry in entry.contestants %}
                            {% if contestant_entry.categories.get(category.id) %}
                                {% set has_scores.value = true %}
                            {% endif %}
                        {% endfor %}
                        {% if has_scores.value %}
                            <div class="score-card mb-3">
                                <div class="score-section-title mb-2">{{ category.name }}</div>
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th>Contestant #</th>
                                                <th>Name</th>
                                                {% for criterion in category_criteria %}
                                                    <th>{{ criterion.name }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for contestant_entry in entry.contestants %}
                                                {% set category_entry = contestant_entry.categories.get(category.id) %}
                                                {% if category_entry %}
                                                    <tr>
                                                        <td>{{ contestant_entry.contestant.number }}</td>
                                                        <td>{{ contestant_entry.contestant.name }}</td>
                                                        {% for criterion in category_criteria %}
                                                            {% set score_value = category_entry.criteria_scores.get(criterion.id) %}
                                                            <td>
                                                                {% if score_value is not none %}
                                                                    {{ "%.2f"|format(score_value) }}
                                                                {% else %}
                                                                    -
                                                                {% endif %}
                                                            </td>
                                                        {% endfor %}
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    {% endfor %}
{% endif %}
{% endblock %}
