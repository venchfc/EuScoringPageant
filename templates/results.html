{% extends "base.html" %}

{% block title %}Results - Pageant Scoring{% endblock %}

{% block extra_css %}
<style>
    .podium {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        margin: 40px 0;
        gap: 20px;
    }
    .podium-place {
        text-align: center;
        padding: 20px 15px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .first-place {
        background: linear-gradient(135deg, #880015 0%, #880015 100%);
        height: 280px;
        width: 200px;
        order: 2;
        border: 4px solid white;
    }
    .second-place {
        background: linear-gradient(135deg, #880015 0%, #880015 100%);
        height: 240px;
        width: 180px;
        order: 1;
        border: 3px solid white;
    }
    .third-place {
        background: linear-gradient(135deg, #880015 0%, #880015 100%);
        height: 200px;
        width: 180px;
        order: 3;
        border: 3px solid white;
    }
    .podium-number {
        font-size: 2.2rem;
        font-weight: bold;
        color: white;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 8px 18px;
        border-radius: 8px;
        display: inline-block;
        margin-bottom: 8px;
    }
    .podium-name {
        font-size: 1rem;
        font-weight: bold;
        color: white;
        margin: 8px 0;
        line-height: 1.2;
    }
    .podium-score {
        font-size: 1.6rem;
        font-weight: bold;
        color: white;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 6px 14px;
        border-radius: 8px;
        display: inline-block;
        margin: 8px 0;
    }
    .podium-label {
        color: white;
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 8px;
        padding: 5px 10px;
        background-color: rgba(255, 255, 255, 0.15);
        border-radius: 6px;
        display: inline-block;
    }
    .rank-badge {
        font-size: 1.5rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
const socket = window.AppSocket;
if (socket) {
    socket.on('scores_update', () => window.location.reload());
    socket.on('category_update', () => window.location.reload());
}
</script>
{% endblock %}

{% block content %}
<h2 class="mb-4 text-center">{{ competition_title }} Results</h2>

{% if read_only_mode %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Read-only view for administrators.
    </div>
{% endif %}

{% if round1_locked or round2_locked or round3_locked %}
    {% if divisions %}
        {% set primary_divisions = ['female', 'male'] %}

        <div class="mt-4">
            <h3 class="mb-3 text-center" style="color: #880015;">Round 1 Final Results</h3>

            {% if round1_partial %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Showing categories with complete judge submissions only.
                </div>
            {% endif %}

            {% if round1_locked %}
                {% for division in primary_divisions %}
                    {% if division in divisions %}
                        {% set division_label = division_labels.get(division, division|title) %}
                        {% set round1_results = round1_results_by_division.get(division, []) %}
                        <div class="mb-4">
                            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">{{ division_label }} Results</h4>
                                <a href="{{ url_for('download_results_pdf_round', round_name='round1', division=division) }}" class="btn btn-primary btn-sm" target="_blank">
                                    <i class="bi bi-file-pdf"></i> Download PDF
                                </a>
                            </div>

                            {% if round1_results %}
                            <div class="table-responsive">
                                <table class="table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Contestant #</th>
                                            <th>Name</th>
                                            {% for category in round1_categories %}
                                            <th>{{ category.name }}<br><small>({{ category.percentage }}%)</small></th>
                                            {% endfor %}
                                            <th>Total Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in round1_results %}
                                        <tr>
                                            <td>
                                                <span class="rank-badge">
                                                    {{ result.rank }}
                                                </span>
                                            </td>
                                            <td><strong>{{ result.contestant.number }}</strong></td>
                                            <td><strong>{{ result.contestant.name }}</strong></td>
                                            {% for category in round1_categories %}
                                            <td>
                                                {% if result.category_scores[category.name] %}
                                                    {{ "%.4f"|format(result.category_scores[category.name].weighted) }}
                                                    <br>
                                                    <small class="text-muted">({{ "%.4f"|format(result.category_scores[category.name].raw) }})</small>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            {% endfor %}
                                            <td><strong style="color: #000000;">{{ "%.4f"|format(result.total_score) }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <div class="alert alert-info mt-4">
                                <h6>Score Breakdown:</h6>
                                <ul class="mb-0">
                                    <li><strong>Weighted Score:</strong> Main number (contributes to total based on category percentage)</li>
                                    <li><strong>Raw Score:</strong> Number in parentheses (actual category score before percentage applied)</li>
                                </ul>
                            </div>

                            {% if show_category_winners and category_winners_by_division.get(division) %}
                            {% set division_winners = category_winners_by_division.get(division) %}
                            <div class="mt-4">
                                <h4 class="mb-3 text-center" style="color: #880015;">Category Winners - {{ division_label }}</h4>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Category</th>
                                                <th>Winner</th>
                                                <th>Contestant #</th>
                                                <th>Category Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for category in round1_categories %}
                                                {% if category.name in division_winners %}
                                                {% set winner_entry = division_winners[category.name] %}
                                                <tr>
                                                    <td><strong>{{ category.name }}</strong></td>
                                                    <td>
                                                        {% for winner in winner_entry.winners %}
                                                            <strong>{{ winner.contestant.name }}</strong>{% if not loop.last %}, {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                    <td>
                                                        {% for winner in winner_entry.winners %}
                                                            <strong>{{ winner.contestant.number }}</strong>{% if not loop.last %}, {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                    <td><strong style="color: #000000;">{{ "%.4f"|format(winner_entry.score) }}</strong></td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="alert alert-info">
                                Round 1 results are not available yet for {{ division_label }}.
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
            <div class="alert alert-warning">
                Round 1 results are hidden until all Round 1 categories are locked.
            </div>
            {% endif %}
        </div>

        <div class="mt-5">
            <h3 class="mb-3 text-center" style="color: #880015;">Round 2 Results</h3>
            {% if round2_partial %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Showing categories with complete judge submissions only.
                </div>
            {% endif %}
            {% if round2_locked %}
                {% for division in primary_divisions %}
                    {% if division in divisions %}
                        {% set division_label = division_labels.get(division, division|title) %}
                        {% set round2_results = round2_results_by_division.get(division, []) %}
                        <div class="mb-4">
                            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">{{ division_label }} Results</h4>
                                <a href="{{ url_for('download_results_pdf_round', round_name='round2', division=division) }}" class="btn btn-primary btn-sm" target="_blank">
                                    <i class="bi bi-file-pdf"></i> Download PDF
                                </a>
                            </div>
                            {% if round2_results %}
                            <div class="table-responsive">
                                <table class="table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Contestant #</th>
                                            <th>Name</th>
                                            {% for category in round2_categories %}
                                            <th>{{ category.name }}<br><small>({{ category.percentage }}%)</small></th>
                                            {% endfor %}
                                            <th>Total Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in round2_results %}
                                        <tr>
                                            <td><strong>{{ result.rank }}</strong></td>
                                            <td><strong>{{ result.contestant.number }}</strong></td>
                                            <td><strong>{{ result.contestant.name }}</strong></td>
                                            {% for category in round2_categories %}
                                            <td>
                                                {% if result.category_scores[category.name] %}
                                                    {{ "%.4f"|format(result.category_scores[category.name].weighted) }}
                                                    <br>
                                                    <small class="text-muted">({{ "%.4f"|format(result.category_scores[category.name].raw) }})</small>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            {% endfor %}
                                            <td><strong style="color: #000000;">{{ "%.4f"|format(result.total_score) }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                Top 5 results are not available yet for {{ division_label }}.
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
            <div class="alert alert-warning">
                Top 5 results are hidden until all Round 2 categories are locked.
            </div>
            {% endif %}
        </div>

        <div class="mt-5">
            <h3 class="mb-3 text-center" style="color: #880015;">Round 3 Results</h3>
            {% if round3_partial %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Showing categories with complete judge submissions only.
                </div>
            {% endif %}
            {% if round3_locked %}
                {% for division in primary_divisions %}
                    {% if division in divisions %}
                        {% set division_label = division_labels.get(division, division|title) %}
                        {% set round3_results = round3_results_by_division.get(division, []) %}
                        <div class="mb-4">
                            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">{{ division_label }} Results</h4>
                                <a href="{{ url_for('download_results_pdf_round', round_name='round3', division=division) }}" class="btn btn-primary btn-sm" target="_blank">
                                    <i class="bi bi-file-pdf"></i> Download PDF
                                </a>
                            </div>
                            {% if round3_results %}
                            <div class="table-responsive">
                                <table class="table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Contestant #</th>
                                            <th>Name</th>
                                            {% for category in round3_categories %}
                                            <th>{{ category.name }}<br><small>({{ category.percentage }}%)</small></th>
                                            {% endfor %}
                                            <th>Total Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in round3_results %}
                                        <tr>
                                            <td><strong>{{ result.rank }}</strong></td>
                                            <td><strong>{{ result.contestant.number }}</strong></td>
                                            <td><strong>{{ result.contestant.name }}</strong></td>
                                            {% for category in round3_categories %}
                                            <td>
                                                {% if result.category_scores[category.name] %}
                                                    {{ "%.4f"|format(result.category_scores[category.name].weighted) }}
                                                    <br>
                                                    <small class="text-muted">({{ "%.4f"|format(result.category_scores[category.name].raw) }})</small>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            {% endfor %}
                                            <td><strong style="color: #000000;">{{ "%.4f"|format(result.total_score) }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                Final results are not available yet for {{ division_label }}.
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
            <div class="alert alert-warning">
                Final results are hidden until all Round 3 categories are locked.
            </div>
            {% endif %}
        </div>
    {% else %}
    <div class="alert alert-info">
        No results available yet. Please add contestants, categories, and scores first.
    </div>
    {% endif %}
{% else %}
    <div class="alert alert-info">
        No results available yet. Please add contestants, categories, and scores first.
    </div>
{% endif %}

<div class="mt-4 text-center">
    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
        Back to Home
    </a>
    <a href="{{ url_for('categories') }}" class="btn btn-outline-secondary">
        Manage Categories
    </a>
</div>
{% endblock %}
